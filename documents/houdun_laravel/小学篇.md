## 基础搭建

### laravel
- 安装
    ```shell
    composer create-project --prefer-dist laravel/laravel lablog
    ```
- 运行
    ```shell
    php artisan serve
    ```
### bootstrap
- 安装laravel ui
    ```shell
    composer require laravel/ui --dev
    ```
- 安装脚手架
    ```shell
    // 生成基本脚手架
    php artisan ui bootstrap
    //php artisan ui vue
    //php artisan ui react

    // 生成 登录/注册 脚手架...
    //php artisan ui bootstrap --auth
    //php artisan ui vue --auth
    //php artisan ui react --auth
    ```
- 在模板文件中引入bootstrap
    ```html
    @vite(['resources/css/app.scss','resources/js/app.js'])
    ```
### blade模板
- 公用模板
    ```
    mkdir resources/views/layouts
    ```
    ```php
    // layouts/default.blade.php
    // 容器及导航部分暂时放这里
    ...
    ```

- 引入模板
    ```php
    // home.blade.php
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        @vite(['resources/sass/app.scss', 'resources/js/app.js'])
        <!-- @vite(['resources/css/app.css']) -->
    </head>
    <body>
    @include('layouts.default');
    </body>
    </html>
    ```


## 登陆注册
### 模型
修改默认数据库迁移文件
```php
Schema::create('users', function (Blueprint $table) {
    $table->id();
    $table->string('username')->unique();
    $table->string('email')->unique()->nullable();
    $table->string('mobile')->unique()->nullable();
    $table->string('nickname')->unique()->nullable()->default('未设置');
    $table->timestamp('email_verified_at')->nullable();
    $table->string('password');
    $table->rememberToken();
    $table->timestamps();
});
```
### 控制器
- 新建资源控制器
    ```shell
    php artisan make:controller --resource UserController
    ```
- 创建路由
    ```php
    Route::resource('user',\App\Http\Controllers\UserController::class);
    ```
###  注册
- 修改注册入口
    ```php
    // layouts/defult.blade.php
    ...
    ```

- 创建模板
    ```shell
    mkdir resources/views/user
    touch resources/views/user/create.blade.php
    ```
    ```php
    // create.blade.php
    @extends('defaults')
    ```
- 419错误
     在提交表单时,store方法,会返回419错误,原因是被跨站点拦截,在表单中添加@csrf方法,会自动为表单添加隐藏的_token字段
     ```php
    <form action="{{route('user.store')}}" method="post">
        @csrf
        ...
    </form>
    ```

- 表单验证
    ```php
    // UserController.php
    $this->validate($request,[
        'username'=>'required|min:4|unique:users',
        'password'=>'required|min:6|confirmed'
    ]);
    ```
- 错误提示
    ```php
    // layouts/_errors.blade.php
    @if(count($errors))
        @foreach($errors->all() as $error)
        <div class="alert alert-primary d-flex align-items-center mt-2" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:" style="width: 18px;">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
          <div>
            {{$error}}
          </div>
        </div>
        @endforeach
    @endif
    ```
    ```php
    // default.blade.php
    <div class="content">
        @include('layouts._errors')
        @yield('content')
    </div>
    ```
- 中文化
    - 安装多语言包
        ```shell
        composer require caouecs/laravel-lang
        ```

- 添加用户到数据库
    ```php
        $data = $this->validate($request,[
            'username'=>'required|min:4|unique:users',
            'password'=>'required|min:6|confirmed'
        ]);
        $data['password'] = bcrypt($data['password']);
        User::create($data);
    ```

    此时,模型添加数据时,会报错

    >  Field 'username' doesn't have a default value


    添加批量赋值fillable
    ```php
    // /app/Models/User.php
    protected $fillable = [
        'username',
        'email',
        'mobile',
        'nickname',
        'password',
    ];
    ```
- 注册后登陆
    ```php
    \Auth::attempt(['username'=>$request->username,'password'=>$request->password]);
    ```
### 登陆
- 登陆后提示
    - 添加推送通知框(toast)
        ```php
        // _errors.blade.php
        @foreach(['success','danger','warning'] as $flag)
            <div class="toast-message-box top-0 end-0 position-absolute">
                @if(session()->has($flag))
                <div class="toast fade toast-message" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                         <!-- <img src="..." class="rounded me-2" alt=""> -->
                        <strong class="me-auto">{{$flag}}</strong>
                        <!-- <small>11 mins ago</small> -->
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        {{session()->get($flag)}}
                    </div>
                </div>
                @endif
            </div>
        @endforeach
        ```

    - 弹出及自动隐藏
        ```php
        // jquery部分
        @section('jquery')
        $('.toast-message').addClass('show')
        var timer = setTimeout(function () {
                $('.toast-message').removeClass('show')
            },
            3000
        )
        @endsection
        ```
- 控制器
    - 新建控制器
        ```php
        php artisan make:controller LoginController
        ```
    
    - 创建登陆方法
        - 路由
            ```php
            Route::get('logout',[LoginController::class,'logout'])->name('logout');
            Route::get('login',[LoginController::class,'login'])->name('login');
            ```
        - login()方法
            ```php
            public function login(Request $request){
                return view('login');
            }
            ```
        - store()方法
            ```php
            public function store(Request $request){
                $data = $this->validate($request,[
                    'username'=>"required",
                    'password'=>"required"
                ]);
                if(Auth::attempt($data)){
                    session()->flash('success','登陆成功');
                    return redirect('/');
                }else{
                    session()->flash('danger','帐号或密码错误');
                    return back();
                }
            }
            ```

    - 创建登出方法
        ```php
        public function logout(){
            Auth::logout();
            session()->flash('success','退出成功');
            return redirect('/');
        }
        ```
    - 修改路由
        ```php
        Route::get('logout',[LoginController::class,'logout'])->name('logout');
        Route::get('login',[LoginController::class,'login'])->name('login');
        Route::post('login',[LoginController::class,'store'])->name('login');
        ```
### 数据填充
- 新建数据填充
    ```shell
    php artisan make:seeder UserSeeder
    ```
- 注册数据填充
    ```php
    // databse/DatebaseSeeder.php
    public function run(): void
    {
        $this->call(UserSeeder::class);
    }
    ```
- 模型工厂
    - 创建模型工厂
        ```shell
        php artisan make:factory --model=User UserFactory
        ```
    - 修改模型工厂
        ```php
        public function definition(): array
        {
            return [
                'username' => fake()->firstName(),
                'email' => fake()->unique()->safeEmail(),
                'email_verified_at' => now(),
                'password' => static::$password ??= Hash::make('111111'),
                'remember_token' => Str::random(10),
            ];
        }
        ```
- 批量填充
    ```php
    // database/UserSeeder.php
    public function run(): void
    {
        User::factory(5)->create();
    }
    ```

> php artisan migrate:refresh 可以重置数据<br>
> bcrypt()和Hash::make()在底层是一样的,所以结果也是一样的,Hash::check(input,user->password)可以校验结果

### 用户列表
- 获取用户列表并传参给模板
    ```php
    {
        $user_list = User::paginate(5);
        return view('user.index',compact('users'));
    }
    ```
- 模板展现
    ```php
    @extends('layouts.default')
    @section ('content')
    <div class="card">
        <div class="card-header">用户列表</div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col" class="col-1">编号</th>
                        <th scope="col">用户名</th>
                        <th scope="col">用户昵称</th>
                        <th scope="col" class="col-2">操作</th>

                    </tr>
                </thead>
                <tbody>
                    @foreach($user_list as $user)
                    <tr>
                        <td scope="row">{{$user->id}}</td>
                        <td scope="row">{{$user->username}}</td>
                        <td scope="row">{{$user->nickname}}</td>
                        <td scope="row">
                            <div class="btn-grouip" role="group" aria-label="option button">
                                <a href="{{route('user.show',$user)}}" class="btn btn-primary btn-sm">查看</a>
                                <a href="{{route('user.edit',$user)}}" class="btn btn-info btn-sm">修改</a>
                                <button class="btn btn-danger btn-sm">删除</button>
                            </div>
                        </td>
                    </tr>
                    @endforeach
                </tbody>
            </table>
        </div>
        <div class="card-footer text-muted">
            {{$user_list->links()}}
        </div>
    </div>
    @endsection
    ```
### 用户资料展示
- 控制器依赖注入用户信息给模板
    ```php
    //public function show($id)
    public function show(User $user)
    {
        return view('user.show',compact('user'));
    }
    ```
    > 在资源控制器里,直接依赖注入,可以省略模型查找

- 模板
    ```php
    @extends('layouts.default')
    @section('content')
    ...
    @endsection
    ```
### 用户资料修改
- 修改基础模板登陆区域
    ```php
    // layouts/default.blade.php
    <form class="d-flex" role="search">
        @auth
        <a href={{route('user.edit',auth()->user())}} class="btn btn-info me-2">修改</a>
        <a href={{route('logout')}} class="btn btn-danger">退出登陆</a>
        @else
            <a href={{route('login')}} class="btn btn-primary m-2">登陆</a>
            <a href={{route('user.create')}} class="btn btn-success m-2">注册</a>
        @endauth
    </form>
    ```
    > auth()->user()方法可以拿到当前用户,route('',\\$user)可以直接拿取模型id,当然也可以使用\$user['id']或者\$user->id

- 控制器传参
    ```php
    public function edit(User $user)
    {
        return view('user.edit',compact('user'));
    }
    ```
- 模板
    ```html
    @extends('layouts.default')
    @section('content')
    <div class="card">
        <div class="card-header">用户编辑</div>
        <form action="{{route('user.update',$user)}}" method="post">
            @csrf
            @method('PUT')
            ...
        </form>
    </div>
    @endsection
    ```
    > HTTP无法进行PUT操作,所以要使用@method('PUT')方法,伪造表单
- 控制器接收
    ```php
    public function update(Request $request, User $user)
    {
        $this->validate($request,[
            'nickname' =>'required|min:3',
            'email' =>'nullable|email',
            //'mobile' =>'nullable', //未添加忽略自己
            'mobile' =>[
                'nullable',
                Rule::unique('users')->ignore($user->mobile)
            ], 
            'password' => 'nullable|min:6|confirmed',
        ]);
        $user->nickname = $request->nickname;
        if($request->password){
            $user->password = bcrypt($request->password);
        }
        $user->mobile=$request->mobile??$user->mobile;
        $user->save();
        session()->flash('success','用户信息修改成功');
        return redirect()->route('user.show',$user);
    }
    ```
    > 此处验证未验证手机号唯一性
### 权限控制
- 控制器中间件控制 
    ```php
    class UserController extends Controller
    {
        public function __construct()
        {
            $this->middleware('auth',[
                'except'=>[
                    'index','show','create','store'
                ]
            ]);
        }
        ...
    }
    ```
- 路由是中间件控制
    ```php
    Route::middleware('auth')->group(function(){
        ... 
    })
    ```
- 登陆用户的注册保护
    - 修改UserController中间件
        ```php
        $this->middleware('guest',[
            'only'=>['create','store']
        ]);
        ```
    - 修改中间件默认跳转地址
        ```php
        public function handle(Request $request, Closure $next, string ...$guards): Response
        {
            $guards = empty($guards) ? [null] : $guards;
            foreach ($guards as $guard) {
                if (Auth::guard($guard)->check()) {
                    return redirect('/');
                }
            }
            return $next($request);
        }
        ```
- 模型策略控制用户执行的方法(用户只能修改自己的资料)
    - 创建模型策略授权控制
        ```shell
        php artisan make:policy --model=User UserPolicy
        ```
    - 修改授权方法
        ```php
        // app/Policies/UserPolicy.php
        /**
         * @param $user 当前登陆用户模型
         * @param $model 当前方法使用的模型
         */
        public function update(User $user, User $model): bool
        {
            return $user->id == $model->id;
        }
        ```
    - 在控制器中使用权限验证
        ```php
        // app/Http/Controllers/UserController.php
        public function edit(User $user)
        {
            $this->authorize('update',$user);
            return view('user.edit',compact('user'));
        }
        ```
    - 在权限服务中启用授权
        ```php
        // app/Providers/AuthServiceProvidcer.php
        protected $policies = [
            'App\Models\User' => UserPolicy::class,
        ];
        ```
### 管理员
- 修改迁移文件,添加is_admin字段
    ```php
    // migrations/create_user_table.php
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            ...
            $table->tinyInteger('is_admin')->default(0);
            ...
        });
    }
    ```
- 修改数据填充字段,把admin改为管理员
    ```php
    public function run(): void
    {
        User::factory(50)->create();
        $user = User::find(1);
        $user->username = 'admin';
        $user->password = Hash::make('88888888');
        $user->is_admin = 1;
        $user->save();
    }
    ```
### 删除用户
- 控制器
    ```php
    public function destroy(User $user)
    {
        $user->delete();
        session()->flash('success','删除用户成功');
        return redirect()->route('user.index');
    }
    ```
- 视图文件
    ```php
    <div class="btn-grouip" role="group" aria-label="option button">
        <a href="{{route('user.show',$user)}}" class="btn btn-primary btn-sm">查看</a>
        <a href="{{route('user.edit',$user)}}" class="btn btn-info btn-sm">修改</a>
        <form action="{{route('user.destroy',$user)}}" method="post">
            @csrf
            @method('DELETE')
            <button type="submit" class="btn btn-danger btn-sm">删除</button>
        </form>
        <!-- <a href="{{route('user.destroy',$user)}}" class="btn btn-danger btn-sm">删除</a> -->
    </div>
    ```

    > 使用@method('DELETE')方法,伪造表单
- 权限管理
    - 修改模型策略
        ```php
        public function delete(User $user, User $model): bool
        {
            return $user->is_admin && $user->id != $model->id;
        }
        ```
    - 在控制器中验证授权
        ```php
        public function destroy(User $user)
        {
            $this->authorize('delete',$user);
            $user->delete();
            session()->flash('success','删除用户成功');
            return redirect()->route('user.index');
        }
        ```
    - 模板中限制权限
        ```php
        <td scope="row">
            <form action="{{route('user.destroy',$user)}}" method="post" id="delete-user-{{$user->id}}" class="m-0">
                @csrf
                @method('DELETE')
                <!-- <button type="submit" class="btn btn-danger btn-sm ms-2">删除</button> -->
            </form>
            <div class="btn-group w-100" role="group" aria-label="option button a">
                <a href="{{route('user.show',$user)}}" class="btn btn-primary btn-sm ">查看</a>
                @can('update',$user)
                <a href="{{route('user.edit',$user)}}" class="btn btn-info btn-sm ">修改</a>
                @endcan
                @can('delete',$user)
                <a href="#" onclick="document.getElementById('delete-user-{{$user->id}}').submit()" class="btn btn-danger btn-sm ">删除</a>
                @endcan
            </div>
        </td>
        ```
    
### 邮箱验证
- 配置文件
    ```config
    MAIL_MAILER=smtp
    MAIL_HOST=smtp.qiye.aliyun.com
    MAIL_PORT=465
    MAIL_USERNAME=web.liuxinyang.cn
    MAIL_PASSWORD="xmlxzl4419.,';"
    MAIL_ENCRYPTION=null
    MAIL_FROM_ADDRESS="web.liuxinyang.cn"
    MAIL_FROM_NAME="测试博客"
    ```
- 创建测试邮件类
    ```shell
    php artisan make:mail TestMail
    ```
- 创建邮件发放模板
    ```php
    // resources/mail/test.blade.php
    <h1>测试标题</h1>
    </h2>这是一个测试邮件</h2>
    ```
- 在邮件类里指定渲染视图
    ```php
    public function content(): Content
    {
        return new Content(
            //view: 'view.name',
            view: 'mail.test',
        );
    }
    ```
- 在控制器中发送邮件
    ```php
    $user = User::find(2);
    \Mail::to($user)->send(new TestMail());
    ```

- 邮件验证码
    - 邮件激活
    - 找回密码
        - 新建password控制器
            ```shell
            php artisan make:controller PasswordController
            ```
        - 创建方法
            ```php
            class PasswordController extends Controller
            {
                public function show(){
                }
                public function send(){
                }
                public function edit(){
                }
                public function update(){
                }
            }
            ```
        - 配置路由
            ```php
            Route::prefix('password')->name('password.')->group(function(){
                Route::get('find',[PasswordController::class,'show'])->name('find');
                Route::post('sendemail',[PasswordController::class,'send'])->name('sendEmail');
                Route::get('reset',[PasswordController::class,'edit'])->name('reset');
                Route::post('update',[PasswordController::class,'update'])->name('update');
            });
            ```
        - 视图
            ```php
            <div class="card">
                <div class="card-header">找回密码</div>
                <form action="{{route('password.sendEmail')}}" method="post">
                    @csrf
                    <div class="card-body">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" name="email" id="email" value="{{old('email')}}">
                            <small id="helpId" class="form-text text-muted">请输入注册时的Email</small>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <button type="submit" class="btn btn-success" id="btn_regist">找回</button>
                    </div>
                </form>
            </div>
            ```
        - 通知
            - 创建通知
                ```shell
                php artisan make:notification FindPasswordNotify
                ```
            - 定义所使用的参数(token)
                ```php
                class FindPasswordNotify extends Notification
                {
                    protected $token;
                    ...
                    public function __construct($token)
                    {
                        $this->token = $token;
                    }
                }
                ```
            - 配置邮件模板
                ```php
                public function toMail(object $notifiable): MailMessage
                {
                    return (new MailMessage)
                                ->subject(config('app.name').'-找回密码')
                                ->line('点击找回密码.')
                                ->action('重置密码', url(route('password.reset',$this->token)))
                                ->line('感谢使用');
                }
                ```
        - 修改reset方法
            ```php
            // 用于测试,后期token需要实现
            public function edit($token){
                if($token == 'test_token'){
                    $user = User::find(1);
                    return view('password.reset',$user);
                }else{
                    session()->flash('warning','邮件已过期,请重新发送邮件!');
                    return redirect('/');
                }
            }
            ```
        - 修改update方法
            ```php
            public function update(Request $request){
                //dd($request->post());
                $request->validate([
                    'password' => 'required|min:6|confirmed'
                ]);
                if($user = User::find($request->user_id)){
                    $user->password = bcrypt($request->password);
                    if($user->save()){
                        //Auth::login($user);
                        session()->flash('success','密码修改成功!');
                        //return redirect(route('user.show',$user));
                        return redirect(route('login'));
                    }else{
                        session()->flash('danger','密码修改失败!');
                        return redirect(route('password.find'));
                    }
                }else{
                    session()->flash('danger','未找到该用户,请联系管理员!');
                    return redirect(route('password.find'));
                }
            }
            ```
        - 修改默认邮件模板
            - 生成默认模板文件
                ```shell
                php artisan vendor:publish --tag=laravel-notifications
                ```
            - 编辑模板文件
                ```php
                // resources/views/vendor/notifications/email.blade.php
                ```
    > 教程中使用的方法是,在创建用户的时候,在user表里的email_token生成一串随机字符,用于验证,感觉不太优雅.感觉还是在数据库生成一张中间表,关联user_id比较正统

    > 如果不需要对比密码,可以使用Auth::login($user)登陆
## 文章
### 数据和迁移
- 创建迁移文件
    ```shell
    php artisan make:migration create_blogs_table --create=blogs
    ```
- 编辑迁移文件
    ```php
    public function up(): void
    {
        Schema::create('blogs', function (Blueprint $table) {
            $table->id();
            $table->string('content',200);
            $table->integer('user_id')->index();
            $table->timestamps();
        });
    }
    ```
- 开始数据迁移
    ```shell
    #php artisan migrate:refresh --seed //重新运行迁移并填充
    php atisan migrate
    ```
### 模型
- 创建模型
    ```shell
    php artisan make:model Blog
    ```
- 定义允许填充字段
    ```php
    protected $fillable=['content'];
    ```
    > $filltable属性可以定义允许被批量赋值的字段

### 控制器
- 创建资源控制器
    ```shell
    php artisan make:controller --resource BlogController --model=Blog
    ```
- 创建路由
    ```php
    Route::resource('blog',\App\Http\Controllers\BlogController::class);
    ```
- 新增(create)
    - 模板
        ```php
        // resources/blog/create.blade.php
        @extends('layouts.default')
        @section('content')
        <form action="{{route('blog.store')}}" method="post">
            @csrf
            <div class="card">
                <div class="card-header">
                    发布文章
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="content">
                            内容
                        </label>
                        <textarea name="content" id="" cols="30" rows="10" class="form-control">
                            {{old('content')}}
                        </textarea>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <button type="submit" class="btn btn-success">发表</button>
                </div>
            </div>
        </form>
        @endsection
        ```
    - 定义多表关联
        ```php
        // app/models/User.php
        public function blogs(){
            return $this->hasMany(Blog::class);
        }
        ```
    - 方法
        ```php
        public function store(Request $request)
        {
            $data = $this->validate($request,[
                'content'=>'required|min:2|max:180'
            ]);
            $user = \Auth::user();
            $user->blogs()->create($data);
            session()->flash('success','文章发布成功!');
            return redirect(route('user.show',$user));
        }
        ```
    - 登陆验证
        ```php
        // BlogController.php
        public function __construct()
        {
            $this->middleware('auth');
        }
        ```
    - 模板登陆验证(没必要?控制器就会跳转)
        ```php
        @auth
        ...
        @endauth
        ```
- 获取列表
    - 控制器
        ```php
        public function index()
        {
            $blogs = Blog::orderBy('id','DESC')->paginate(10);
            return view('blog.index',compact('$blogs'));
        }
        ```
    - 视图
        ```php
        // 基本同user.index相同
        ```
    - 模型工厂
        - 创建模型工厂
            ```shell
            php artisan make:factory --model=Blog BlogFactory
            ```
        - 设置填充内容
            ```php
            public function definition(): array
            {
                return [
                    'content'=>fake()->text(150),
                    'user_id'=>fake()->randomElement([1,2,3,4,5,6,7])
                ];
            }
            ```
        - tinker测试
            ```shell
            php artisan tinker
            \App\Models\Blog::factory(20)->create();
            ```
    - 数据填充
        - 创建填充
            ```shell
            php artisan make:seeder BlogSeeder
            ```
        - 修改填充方法
            ```php
            // database/seeders/BlogSeeder.php
            public function run(): void
            {
                Blog::factory(50)->create();
            }
            ```
        - 注册填充方法
            ```php
            $this->call(BlogSeeder::class);
            ```
    - 多对一关联User表    
        ```php
        // app/Models/Blog.php
        public function user(){
            $this->belongsTo(User::class);
        }
        ```
    - 减少sql查询
        ```php
        public function index()
        {
            $blogs = Blog::orderBy('id','DESC')->with('user')->paginate(10);
            return view('blog.index',compact('blogs'));
        }
        ```
- 删除
    - 创建授权策略 
        ```shell
        php artisan make:policy --model=Blog BlogPolycy
        ```
    - 编辑策略
        ```php
        // app/Policies/BlogPolycy.php
        public function delete(User $user, Blog $blog): bool
        {
            return $user->is_admin || $user->id == $blog->user_id;
        }
        ```
    - 注册策略
        ```php
        // app/Providers/AuthServiceProvidcer.php
        protected $policies = [
            'App\Models\User' => UserPolicy::class,
            'App\Models\Blog' => BlogPolycy::class,
        ];
        ```
    - 前端操作按钮控制
        ```php
        @can('delete',$blog)
        <a href="#" onclick="document.getElementById('delete-blog-{{$blog->id}}').submit()" class="btn btn-danger btn-sm ">删除</a>
        @endcan
        ```
## 关注
### 数据迁移
- 创建迁移文件
    ```shell
    php artisan make:migration --create=follows create_follow_table
    ```
- 编辑迁移文件
    ```php
    public function up(): void
    {
        Schema::create('follows', function (Blueprint $table) {
            $table->id();
            $table->integer('user_id');
            $table->integer('follower');
            $table->timestamps();
        });
    }
    ```
- 开始数据迁移
    ```shell
    #php artisan migrate:refresh --seed //重新运行迁移并填充
    php atisan migrate
    ```
### 模型
- 多表关联
    ```php
    // app/Models/User.php
    // 查看当前用户的粉丝
    public function follower(){
        $this->belongsToMany(User::class,'follows','user_id','follower');
    }
    // 查看当前用户关注的用户
    public function following(){
        $this->belongsToMany(User::class,'follows','follower','user_id');
    }
    ```
    > belongToMany(关联模型，关联表，查询的定做，关联字段)

- 查看当前用户是否观注(用户id)
    ```php
    public function isFollow($uid){
        $this->following()->wherePivot('follower',$uid)->first();
    }
    ```
- 关注或者取关
    ```php
    public function followToggle($ids){
        $ids = is_array($ids)?:[$ids];
        $this->follower()->withTimestamps()->toggle($ids);
    }
    ```
    > withTimestamps()方法,可以自动维护时间字段
### 控制器
- 路由配置
    ```php
    Route::get('follow/{user}',[\App\Http\Controllers\UserController::class,'follow'])->name('user.follow');
    ```
- 关注用户
    ```php
    public function follow(User $user){
        \Auth::user()->followToggle($user->id);
        return back();
    }
    ```
- 显示粉丝关注及按钮
    ```php
    <div class="card-header">
        <b>{{$user['username']}}资料</b>
        <small>
            粉丝:{{$user->follower()->count()}}&emsp;关注:{{$user->following->count()}}
        </small>
        <div class="float-end">
            @auth
            &nbsp;<a href="{{route('user.follow',$user)}}">[{{$is_follow}}]</a>
            @endauth
        </div>
    </div>
    ```
- 粉丝及关注列表
    - 新建控制器
        ```shell
        php artisan make:controller FollowController
        ```
    - 路由
        ```php
        Route::prefix('user')->name('user.')->group(function(){
            Route::get('follow/{user}',[\App\Http\Controllers\UserController::class,'follow'])->name('follow');
            Route::get('follower/{user}',[\App\Http\Controllers\FollowController::class,'follower'])->name('follower');
            Route::get('following/{user}',[\App\Http\Controllers\FollowController::class,'following'])->name('following');
        });
        ```
    - 设置分页样式
    ```php    
    // app/providers/AppServiceProvider
    public function boot(): void
    {
        Paginator::useBootstrapFive();
    }
    ```





