## 安装 
### laravel
- 安装
    ```shell
    composer create-project --prefer-dist laravel/laravel McCms
    ```
- 启动
    ```shell
    php artisan serv
    ```
### 数据库
- 新建数据库
    ```sql
    create database mc_cms character set utf8mb4;
    ```
- 修改配置文件
    ```config
    // .env
    DB_CONNECTION=mysql
    DB_HOST=127.0.0.1
    DB_PORT=3306
    DB_DATABASE=mc_cms
    DB_USERNAME=root
    DB_PASSWORD=xmlxzl
    ```
- 执行数据迁移,创建初始数据
    ```shell
    php artisan migrate
    ```
### 模块化
- 安装依赖库
    ```shell
    composer require nwidart/laravel-modules
    ```
- 发布配置文件
    ```shell
    php artisan vendor:publish --provider="Nwidart\Modules\LaravelModulesServiceProvider"
    ```
- 添加自动加载
    ```php
    // coposer.json
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/",
            "Modules\\": "Modules/"
        }
    },
    ```
- 更新自动加载
    ```shell
    composer dump-autoload
    ```
## 登陆注册
### 生成登录认证模版
- 原教程
    ```php  
    php artisan make:auth
    ```
- 现命令
    ```shell
    composer require laravel/ui --dev
    php artisan ui bootstrap --auth
    ```
    ```shell
    npm install
    npm run dev
    ```
    >注意ui扩展包带有vite模块,所以需要安装nodejs包,和运行监听程序才能启动

> laravel6以后,make:auth命令移除,可通过laravel/ui扩展包进行生成
### 本地化
- 安装扩展包
    ```shell
    composer require --dev laravel-lang/common
    ```
    > 注意:步骤会提示需要bcmath扩展包,ArchLinux的默认php已经默认包含些扩展,php.ini里取消注释即可

- 发布本地化文件
    ```shell
    // 更改app.php的local字段后
    php artisan lang:update
    ```
### 模板
- 复制文件资源文件
    ```shell
    cp bootstrap-admin/{dist,lib} Modules/Admin/resources/ -rf
    ```
- 编辑基础模板
    ```php
    ```
- 清除编译文件
    ```shell
    php artisan view:clear
    ```
### vite使用静态资源
- 使用前先在js里导入
    ```js
    import.meta.glob([
      '../bsa/**',
    ]);
    ```
- 使用的时候使用Vite::asset方法加载
    ```php
    <link rel="stylesheet" href="{{ Vite::asset('resources/bsa/bootstrap-admin.min.css') }}">
    ```

## 后台模块
### 基础安装
- 创建模块
    ```shell
    php artisan module:make Admin
    ```
- 路由管理
    ```
    // 框架的路由
    Route::get('admin',[AdminController::class,'index']);
    // 框架内部路由
    Route::prefix('admin')->name('admin.')->group(function () {
        // 框架内部主页的路由
        Route::get('home',[AdminController::class,'home'])->name('home');
    });
    ```
- 模板渲染方法
    ```php
    return view('admin::index',compact('menus'));
    ```
- 模板中的引用和继承
    ```php
    @include('admin::layouts._header')
    @extends('admin::layouts.base')
    ```
### 前后端用户分离
- 新建认证守卫
    ```php
    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
        'admin' => [
            'driver' => 'session',
            'provider' => 'admins',
        ],
    ],
    ```
- 新建数据提供者
    - 创建模型
        ```shell
        php artisan make:model Admin -fm
        ```
        > f参数可以同时创建工厂模式文件,m参数是同时创建数据迁移文件
    - 新建提供者
    ```php
    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => App\Models\User::class,
        ],
        'admins' => [
            'driver' => 'eloquent',
            'model' => App\Models\Admin::class,
        ],
    ],
    ```
- 数据
    - 更改数据迁移
        ```php
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('username');
            $table->string('nickname');
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });
        ```
    - 更改工厂模式
        ```php
        public function definition(): array
        {
            return [
            'username'=>fake()->userName(),
            'password'=>bcrypt('123456'),
            'nickname'=>fake()->name(),
            ];
        }
        ```
    - 新建数据填充
        ```shell
        php artisan make:seeder AdminSeeder
        ```
        ```php
        public function run(): void
        {
            $data = Admin::factory(6)->create();
            $user = $data[0];
            $user->username = 'admin';
            $user->nickname = '系统管理员';
            $user->save();
        }
        ```
    - 注册数据填充
        ```php
        // database/seeders/DatabaseSeeder.php
        public function run(): void
        {
            $this->call(AdminSeeder::class);
        }
        ```

### 复制控制器到ADMIN
- 复制文件
    ```shell
    cp -r /app/Http/Controllers/Auth /Modules/Admin/App/Http/Controllers/
    ```
- 更改命名空间
    ```php
    //namespace App\Http\Controllers\Auth;
    namespace Modules\Admin\App\Http\Controllers\Auth;
    ```
- 创建路由
    ```php
    // 框架内部路由
    Route::prefix('admin')->name('admin.')->group(function () {
        // 认证模块
        Auth::routes();
        // 框架内部主页的路由
        Route::get('home',[AdminController::class,'home'])->name('home');
    });
    ```
- 重写方法渲染模块登陆页面
    ```php
    // Modules/Admin/App/Http/Controllers/loginController.php
    public function showLoginForm()
    {
        return view('admin::login');
    }
    ```
- 重写父类方法,设置登陆字段
    ```php
    // loginController.php
    public function username()
    {
        return "username";
    }
    ```
- 重写父类方法,设置守卫
    ```php
    protected function guard()
    {
        return \Auth::guard('admin');
    }
    ```
- 更改Admin模型的父类,继承守卫者等方法
    ```php
    namespace App\Models;
    use Illuminate\Database\Eloquent\Factories\HasFactory;
    use Illuminate\Foundation\Auth\User;
    class Admin extends User
    {
        use HasFactory;
    }
    ```
- 更改登陆成功后跳转
    ```php
    protected $redirectTo = '/admin';
    ```
- 修改构造方法,给guest中间件传递守卫者
    ```php
    public function __construct()
    {
        //$this->middleware('guest')->except('logout');
        $this->middleware('guest:admin')->except('logout');
    }
    ```
- 改造guest中间件,当守卫为admin时,跳转到自定义网址
    ```php
    public function handle(Request $request, Closure $next, string ...$guards): Response
    {
        $guards = empty($guards) ? [null] : $guards;
        foreach ($guards as $guard) {
            if (Auth::guard($guard)->check()) {
                //return redirect(RouteServiceProvider::HOME);
                return redirect($guard=='admin'?'/admin/':RouteServiceProvider::HOME);
            }
        }
        return $next($request);
    }
    ```
- 修改Admin路由分组中间件,防止非登陆访问
    ```php
    // 框架的路由
    Route::middleware('web','auth:admin')->get('admin',[AdminController::class,'index']);

    // 框架内部路由
    Route::prefix('admin')->name('admin.')->middleware('web','auth:admin')->group(function () {
        // 认证模块
        Auth::routes();
        // 框架内部主页的路由
        Route::get('home',[AdminController::class,'home'])->name('home');
    });
    ```
- 修改auth中间件跳转地址
    ```php
    // app/Exceptions/Handler.php
    // 重写父类方法
    protected function unauthenticated($request, AuthenticationException $exception)
    {
        $guards = $exception->guards();
        if($this->shouldReturnJson($request, $exception)){
            return response()->json(['message' => $exception->getMessage()], 401);
        }else{
            $url = in_array('admin',$guards)?'/admin/login':'/login';
            return redirect($url);
        }
    }
    ```

- 根据后端$errors添加jquery方法
    ```php
    <div class="invalid-feedback d-none" data-fv-validator="notEmpty" data-fv-for="username" data-fv-result="INVALID" style="display: block;" id="error_password"></div>
    ...
    @if(count($errors))
        @foreach($errors->all() as $error)
            @if(strstr($error,'邮箱'))
                <script>
                    $('#error_username').removeClass('d-none').append('{{$error}}')
                </script>
            @endif
            @if(strstr($error,'密码'))
                <script>
                    $('#error_password').removeClass('d-none').append('{{$error}}')
                </script>
            @endif
        @endforeach
    @endif
    ```
- 前端模板基础添加toast消息
    ```php
    @foreach(['success','warning','danger','primary'] as $flag)
        @if(session()->has($flag))
        <script>
        $.toasts({
            type: '{{$flag}}',
            content: '{{session()->get($flag)}}',
            onHidden: function () {
            }
        })
        </script>
        @endif
    @endforeach
    ```
## 角色管理
### 控制器
- 创建控制器    
    ```php
    php artisan module:make-controller RoleController Admin
    ```




