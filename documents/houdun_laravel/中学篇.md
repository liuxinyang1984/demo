## 安装 
### laravel
- 安装
    ```shell
    composer create-project --prefer-dist laravel/laravel McCms
    ```
- 启动
    ```shell
    php artisan serv
    ```
### 数据库
- 新建数据库
    ```sql
    create database mc_cms character set utf8mb4;
    ```
- 修改配置文件
    ```config
    // .env
    DB_CONNECTION=mysql
    DB_HOST=127.0.0.1
    DB_PORT=3306
    DB_DATABASE=mc_cms
    DB_USERNAME=root
    DB_PASSWORD=xmlxzl
    ```
- 执行数据迁移,创建初始数据
    ```shell
    php artisan migrate
    ```
### 模块化
- 安装依赖库
    ```shell
    composer require nwidart/laravel-modules
    ```
- 发布配置文件
    ```shell
    php artisan vendor:publish --provider="Nwidart\Modules\LaravelModulesServiceProvider"
    ```
- 添加自动加载
    ```php
    // coposer.json
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/",
            "Modules\\": "Modules/"
        }
    },
    ```
- 更新自动加载
    ```shell
    composer dump-autoload
    ```
## 登陆注册
### 生成登录认证模版
- 原教程
    ```php  
    php artisan make:auth
    ```
- 现命令
    ```shell
    composer require laravel/ui --dev
    php artisan ui bootstrap --auth
    ```
    ```shell
    npm install
    npm run dev
    ```
    >注意ui扩展包带有vite模块,所以需要安装nodejs包,和运行监听程序才能启动

> laravel6以后,make:auth命令移除,可通过laravel/ui扩展包进行生成
### 本地化
- 安装扩展包
    ```shell
    composer require --dev laravel-lang/common
    ```
    > 注意:步骤会提示需要bcmath扩展包,ArchLinux的默认php已经默认包含些扩展,php.ini里取消注释即可

- 发布本地化文件
    ```shell
    // 更改app.php的local字段后
    php artisan lang:update
    ```
### 模板
- 复制文件资源文件
    ```shell
    cp bootstrap-admin/{dist,lib} Modules/Admin/resources/ -rf
    ```
- 编辑基础模板
    ```php
    ```
- 清除编译文件
    ```shell
    php artisan view:clear
    ```
### vite使用静态资源
- 使用前先在js里导入
    ```js
    import.meta.glob([
      '../bsa/**',
    ]);
    ```
- 使用的时候使用Vite::asset方法加载
    ```php
    <link rel="stylesheet" href="{{ Vite::asset('resources/bsa/bootstrap-admin.min.css') }}">
    ```

## 后台模块
### 基础安装
- 创建模块
    ```shell
    php artisan module:make Admin
    ```
- 路由管理
    ```
    // 框架的路由
    Route::get('admin',[AdminController::class,'index']);
    // 框架内部路由
    Route::prefix('admin')->name('admin.')->group(function () {
        // 框架内部主页的路由
        Route::get('home',[AdminController::class,'home'])->name('home');
    });
    ```
- 模板渲染方法
    ```php
    return view('admin::index',compact('menus'));
    ```
- 模板中的引用和继承
    ```php
    @include('admin::layouts._header')
    @extends('admin::layouts.base')
    ```
### 前后端用户分离
- 新建认证守卫
    ```php
    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
        'admin' => [
            'driver' => 'session',
            'provider' => 'admins',
        ],
    ],
    ```
- 新建数据提供者
    - 创建模型
        ```shell
        php artisan make:model Admin -fm
        ```
        > f参数可以同时创建工厂模式文件,m参数是同时创建数据迁移文件
    - 新建提供者
    ```php
    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => App\Models\User::class,
        ],
        'admins' => [
            'driver' => 'eloquent',
            'model' => App\Models\Admin::class,
        ],
    ],
    ```
- 数据
    - 更改数据迁移
        ```php
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('username');
            $table->string('nickname');
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });
        ```
    - 更改工厂模式
        ```php
        public function definition(): array
        {
            return [
            'username'=>fake()->userName(),
            'password'=>bcrypt('123456'),
            'nickname'=>fake()->name(),
            ];
        }
        ```
    - 新建数据填充
        ```shell
        php artisan make:seeder AdminSeeder
        ```
        ```php
        public function run(): void
        {
            $data = Admin::factory(6)->create();
            $user = $data[0];
            $user->username = 'admin';
            $user->nickname = '系统管理员';
            $user->save();
        }
        ```
    - 注册数据填充
        ```php
        // database/seeders/DatabaseSeeder.php
        public function run(): void
        {
            $this->call(AdminSeeder::class);
        }
        ```

### 复制控制器到ADMIN
- 复制文件
    ```shell
    cp -r /app/Http/Controllers/Auth /Modules/Admin/App/Http/Controllers/
    ```
- 更改命名空间
    ```php
    //namespace App\Http\Controllers\Auth;
    namespace Modules\Admin\App\Http\Controllers\Auth;
    ```
- 创建路由
    ```php
    // 框架内部路由
    Route::prefix('admin')->name('admin.')->group(function () {
        // 认证模块
        Auth::routes();
        // 框架内部主页的路由
        Route::get('home',[AdminController::class,'home'])->name('home');
    });
    ```
- 重写方法渲染模块登陆页面
    ```php
    // Modules/Admin/App/Http/Controllers/loginController.php
    public function showLoginForm()
    {
        return view('admin::login');
    }
    ```
- 重写父类方法,设置登陆字段
    ```php
    // loginController.php
    public function username()
    {
        return "username";
    }
    ```
- 重写父类方法,设置守卫
    ```php
    protected function guard()
    {
        return \Auth::guard('admin');
    }
    ```
- 更改Admin模型的父类,继承守卫者等方法
    ```php
    namespace App\Models;
    use Illuminate\Database\Eloquent\Factories\HasFactory;
    use Illuminate\Foundation\Auth\User;
    class Admin extends User
    {
        use HasFactory;
    }
    ```
- 更改登陆成功后跳转
    ```php
    protected $redirectTo = '/admin';
    ```
- 修改构造方法,给guest中间件传递守卫者
    ```php
    public function __construct()
    {
        //$this->middleware('guest')->except('logout');
        $this->middleware('guest:admin')->except('logout');
    }
    ```
- 改造guest中间件,当守卫为admin时,跳转到自定义网址
    ```php
    public function handle(Request $request, Closure $next, string ...$guards): Response
    {
        $guards = empty($guards) ? [null] : $guards;
        foreach ($guards as $guard) {
            if (Auth::guard($guard)->check()) {
                //return redirect(RouteServiceProvider::HOME);
                return redirect($guard=='admin'?'/admin/':RouteServiceProvider::HOME);
            }
        }
        return $next($request);
    }
    ```
- 修改Admin路由分组中间件,防止非登陆访问
    ```php
    // 框架的路由
    Route::middleware('web','auth:admin')->get('admin',[AdminController::class,'index']);

    // 框架内部路由
    Route::prefix('admin')->name('admin.')->middleware('web','auth:admin')->group(function () {
        // 认证模块
        Auth::routes();
        // 框架内部主页的路由
        Route::get('home',[AdminController::class,'home'])->name('home');
    });
    ```
- 修改auth中间件跳转地址
    ```php
    // app/Exceptions/Handler.php
    // 重写父类方法
    protected function unauthenticated($request, AuthenticationException $exception)
    {
        $guards = $exception->guards();
        if($this->shouldReturnJson($request, $exception)){
            return response()->json(['message' => $exception->getMessage()], 401);
        }else{
            $url = in_array('admin',$guards)?'/admin/login':'/login';
            return redirect($url);
        }
    }
    ```

- 根据后端$errors添加jquery方法
    ```php
    <div class="invalid-feedback d-none" data-fv-validator="notEmpty" data-fv-for="username" data-fv-result="INVALID" style="display: block;" id="error_password"></div>
    ...
    @if(count($errors))
        @foreach($errors->all() as $error)
            @if(strstr($error,'邮箱'))
                <script>
                    $('#error_username').removeClass('d-none').append('{{$error}}')
                </script>
            @endif
            @if(strstr($error,'密码'))
                <script>
                    $('#error_password').removeClass('d-none').append('{{$error}}')
                </script>
            @endif
        @endforeach
    @endif
    ```
- 前端模板基础添加toast消息
    ```php
    @foreach(['success','warning','danger','primary'] as $flag)
        @if(session()->has($flag))
        <script>
        $.toasts({
            type: '{{$flag}}',
            content: '{{session()->get($flag)}}',
            onHidden: function () {
            }
        })
        </script>
        @endif
    @endforeach
    ```
## 角色管理(RBAC)
### 基础组件及控制器
#### laravel-permission组件
- 安装
    ```shell
    composer require spatie/laravel-permission
    ```
- 发布migration和配置文件
    ```shell
    php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"
    ```
- 更改迁移文件,添加中文字段
    ```php
    Schema::create($tableNames['roles'], function (Blueprint $table) use ($teams, $columnNames) {
        $table->bigIncrements('id'); // role id
        if ($teams || config('permission.testing')) { // permission.testing is a fix for sqlite testing
            $table->unsignedBigInteger($columnNames['team_foreign_key'])->nullable();
            $table->index($columnNames['team_foreign_key'], 'roles_team_foreign_key_index');
        }
        $table->string('name');       // For MySQL 8.0 use string('name', 125);
        $table->string('ename');       // For MySQL 8.0 use string('name', 125);
        $table->string('guard_name'); // For MySQL 8.0 use string('guard_name', 125);
        $table->timestamps();
        if ($teams || config('permission.testing')) {
            $table->unique([$columnNames['team_foreign_key'], 'name', 'guard_name']);
        } else {
            $table->unique(['name', 'guard_name']);
        }
    });
    ```
#### 角色控制器
- 创建控制器    
    ```php
    php artisan module:make-controller RoleController Admin
    ```

### 角色
#### 创建一个模态框组件
- 创建一个模态框模板
    ```shell
    mkdir Modules/Admin/resources/views/components
    touch Modules/Admin/resources/views/components/Modal.blade.php
    ```
- 编辑模板
    ```php
    <div class="modal fade " id="{{$id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <form action="{{$url}}" method="post">
            @csrf
            @isset($method)
                @method($method)
            @endisset
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header ">
                    <h5 class="modal-title" id="exampleModalLabel">{{$title}}</h5>
                    <button type="button" class="btn-close text-light" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {{$slot}}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">确定</button>
                </div>
            </div>
        </div>
        </form>
    </div>
    ```
- 引用组件
    ```php
    @component('admin::components.modal',['id'=>'addRole','title'=>'添加角色','url'=>route('admin.role.store')])
    <div class="row mb-3">
        <label for="name" class="col-sm-3 col-form-label text-sm-end">角色名称</label>
        <div class="col-sm-9">
            <input type="text" class="form-control" id="name" name="name" value="" data-fv-field="name" autocomplete="off" value="{{old('name')}}">
            <div class="invalid-feedback d-none" data-fv-validator="notEmpty" data-fv-for="name"
                data-fv-result="NOT_VALIDATED" id="error-name"></div>
        </div>
    </div>
    <div class="row mb-3">
        <label for="name" class="col-sm-3 col-form-label text-sm-end">角色标识</label>
        <div class="col-sm-9">
            <input type="text" class="form-control" id="ename" name="ename" value="" data-fv-field="ename"
                autocomplete="off" value="old('ename')">
            <div class="invalid-feedback d-none" data-fv-validator="notEmpty" data-fv-for="name"
                data-fv-result="NOT_VALIDATED" id="error-ename"></div>
        </div>
    </div>
    @endcomponent
    ```
#### request验证
- 创建一个request验证
    ```shell
    php artisan module:make-request RoleRequest Admin
    ```
- 启用验证
    ```php
    public function store(RoleRequest $request): RedirectResponse
    {
        dd($request->all());
    }
    ```
- 定义验证
    ```php
    public function rules(): array
    {
        return [
            'name'=>'required|unique:roles',
            'ename'=>'required|unique:roles'
        ];
    }
    public function messages()
    {
        return [
            'name.required'=>'角色名称不能为空',
            'name.unique'=>'角色名称已经存在',
            'ename.required'=>'角色描述不能为空',
            'ename.unique'=>'角色描述已经存在'
        ];
    }
    ```
    
#### 新建角色
    ```php
    use Spatie\Permission\Models\Role;
    ...
    public function store(RoleRequest $request): RedirectResponse
    {
        try{
            Role::create([
                'name'=>$request->name,
                'ename'=>$request->ename
            ]);
        }catch(\Exception $e){
            dd($e->getMessage());
        }
        session()->flash('success','角色添加成功');
        return back();
    }
    ```
#### 编辑角色
- 引用Modal组件
    ```php

    @component('admin::components.modal',['id'=>'edit_role_'.$role->id,'title'=>'编辑角色','url'=>route('admin.role.update',$role->id)])
    <div class="row mb-3">
        <label for="name" class="col-sm-3 col-form-label text-sm-end">角色名称</label>
        <div class="col-sm-9">
            <input type="text" class="form-control" id="name" name="name" data-fv-field="name" autocomplete="off" value="{{$role->name}}">
            <div class="invalid-feedback d-none" data-fv-validator="notEmpty" data-fv-for="name"
                data-fv-result="NOT_VALIDATED" id="error-name"></div>
        </div>
    </div>
    <div class="row mb-3">
        <label for="name" class="col-sm-3 col-form-label text-sm-end">角色标识</label>
        <div class="col-sm-9">
            <input type="text" class="form-control" id="ename" name="ename" data-fv-field="ename"
                autocomplete="off" value="{{$role->ename}}">
            <div class="invalid-feedback d-none" data-fv-validator="notEmpty" data-fv-for="name"
                data-fv-result="NOT_VALIDATED" id="error-ename"></div>
        </div>
    </div>
    @endcomponent
    ```
- 激活按钮功能
    ```html
    <button type="button" class="btn btn-success btn-sm edit-btn" data-bs-placement="top " data-bs-title="修改角色" data-bs-toggle="modal" data-bs-target="#edit_role_{{$role->id}}">
        <i class="bi bi-pencil"></i>
    </button>
    ```
- 验证
    - 修改依赖注入
        ```php
        public function update(RoleRequest $request, Role $role): RedirectResponse
        {
            dd($request->all());
        }
        ```
    - 修改验证,忽略自己
        ```php
        public function rules(): array
        {
            $role = $this->route('role');
            $id = $role?$role->id:null;
            return [
                'name'=>'required|unique:roles,name,'.$id,
                'ename'=>'required|unique:roles,ename,'.$id
            ];
        }
        ```
        > 依赖注入后,在route('role')取到的是注入的对象,而不是路由里的id
#### 数据填充
- 新建
    ```shell
    php artisan module:make-seed PermissionSeeder Admin
    ```
- 编辑
    ```php
    public function run(): void
    {
        $system = Permission::create([
            'name'=>'Admin::system',
            'cname'=>"系统设置",
            'pid' => 0,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::system web_config',
            'cname'=>"网站设置",
            'pid' =>$system->id,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::system mail_config',
            'cname'=>"邮件设置",
            'pid' =>$system->id,
            'guard_name'=>'admin'
        ]);
        $role = Permission::create([
            'name'=>'Admin::role',
            'cname'=>"权限管理",
            'pid' => 0,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::role role',
            'cname'=>"角色管理",
            'pid' => $role->id,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::role permission',
            'cname'=>"权限管理",
            'pid' => $role->id,
            'guard_name'=>'admin'
        ]);

        $store = Permission::create([
            'name'=>'Admin::store config',
            'cname'=>"仓库设置",
            'pid' => 0,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::store config product',
            'cname'=>"产品设置",
            'pid' => $store->id,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::store config part',
            'cname'=>"配件设置",
            'pid' => $store->id,
            'guard_name'=>'admin'
        ]);
        $store_manage = Permission::create([
            'name'=>'Admin::store manage',
            'cname'=>"库存管理",
            'pid' => 0,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::store product',
            'cname'=>"产品库存",
            'pid' => $store_manage->id,
            'guard_name'=>'admin'
        ]);
        Permission::create([
            'name'=>'Admin::store part',
            'cname'=>"库存",
            'pid' => $store_manage->id,
            'guard_name'=>'admin'
        ]);
    }
    ```
- 编辑默认角色数据填充
    ```php
    public function run(): void
    {
        $role =Role::create([
            'name'=>'admin',
            'cname'=>'管理员',
            'guard_name'=>'admin'
        ]);
        $role->syncPermissions(Permission::get());
        Role::create([
            'name'=>'storer',
            'cname'=>'仓库管理员',
            'guard_name'=>'admin'
        ]);

    }
    ```
### 权限
#### 权限编辑页
- 路由
    ```php
    Route::get('role/permission/{role}',[RoleController::class,'permission'])->name('role.permission');
    Route::put('role/permission/{role}',[RoleController::class,'updatePermission'])->name('role.permission.update');
    ```
- 模板
    ```php
    <div class="card border-0 shadow-sm">
        <form action="{{route('admin.role.permission.update',$role)}}" method="post">
        @csrf
        @method('PUT')
        <div class="card-header bg-body">
            {{$role->cname}}[{{$role->name}}]权限编辑
        </div>
        <div class="card-body">
        @foreach($permissions as $permission)
            @if($permission->pid == 0)
            <p>{{$permission->cname}}</p>
            <div class="input-group mb-3 pl-5">
                @foreach($permissions as $subPermission)
                    @if($subPermission->pid == $permission->id)
                    <div class="form-check form-switch m-3">
                        <input class="form-check-input"
                            type="checkbox"
                            id="switch-{{$subPermission->id}}"
                            value="{{$subPermission->name}}"
                            name="permission[]"
                            {{$role->hasPermissionTo($subPermission->name)?'checked':''}}
                            >
                        <label class="form-check-label" for="switch-{{$subPermission->id}}">{{$subPermission->cname}}</label>
                    </div>
                    @endif
                @endforeach
            </div>
            @endif

        @endforeach
        </div>
        <div class="card-footer">
            <input type="submit" value="提交">
        </div>
        </form>
    </div>
    ```
    > hasPermissionTo($permission)方法判断当前角色是否拥有方权限,从而实现checked控制

    > checkbox用name="permission[]"属性奖选项提交进一个数组

- 控制器
    ```php
    public function permission(Role $role){
        $permissions = Permission::get();
        return view('admin::role.permission',compact('permissions','role'));
    }
    public function updatePermission(Request $request,Role $role){
        $role->syncPermissions($request->permission);
        session()->flash('success','修改权限成功');
        return redirect(route('admin.role.index'));
    }
    ```
    > syncPermissions()方法,可以动态同步权限状态,不需要手动添加和删除权限

#### 编辑默认管理员角色
- 继承角色类
    ```php
    use Spatie\Permission\Traits\HasRoles;
    class Admin extends User
    {
        use HasFactory,HasRoles;
    }
    ```
- 修改数据填充
    ```php
    public function run(): void
    {
        $role =Role::create([
            'name'=>'admin',
            'cname'=>'管理员',
            'guard_name'=>'admin'
        ]);
        $role->syncPermissions(Permission::get());
        Admin::find(1)->assignRole('admin');
        Role::create([
            'name'=>'storer',
            'cname'=>'仓库管理员',
            'guard_name'=>'admin'
        ]);
    }
    ```
    > 继承HasRoles类后,使用assignRole()赋予用户权限

#### 删除权限
- 前端页面
    ```php
    <button type="button" class="btn btn-danger btn-sm edit-btn" data-bs-placement="top " data-bs-title="删除角色"
        data-bs-toggle="modal" data-bs-target="#del_role_{{$role->id}}">
        <i class="bi bi-trash3"></i>
    </button>
    ...
    @component('admin::components.modal',['id'=>'del_role_'.$role->id,'title'=>'删除角色','url'=>route('admin.role.destroy',$role->id),'method'=>'DELETE'])
    <p>确定要删除角色{{$role->name}}吗?</p>
    @endcomponent
    ```
- 控制器
    ```php
    public function destroy(Role $role)
    {
        if($role->delete()){
            return back()->with('success','删除成功');
        }else{
            return back()->with('danger','删除失败');
        }
    }
    ```
    > back() redirect()等可以直接跟with()方法,相当于session()->flash().

## 文章
### 新建模块、控制器、模型
- 新建模块
    ```shell
    php artisan module:make Article
    ```
- 新建控制器
    ```shell
    php artisan module:make-controller CategoryController Article
    ```
- 新建模型
    ```shell
    php artisan module:make-model Category Article -fm
    ```
    > -fm参数可以同时创建工厂模式及数据迁移文件
- 修改数据迁移
    ```php
    public function up(): void
    {
        Schema::create('categories', function (Blueprint $table) {
            $table->id();
            $table->string('name')->comment('分类名称');
            $table->string('pid')->comment('父级分类');
            $table->string('thumb')->comment('缩略图');
            $table->integer('click')->comment('点击量');
            $table->timestamps();
        });
    }
    ```
    ```shell
    php artisan migrate
    ```
    > 如果想执行执行refresh,可以执行：module:migrate-refresh Article.从而不影响别的数据
- 路由
    ```php
    Route::prefix('article')->name('article.')->middleware(['web','auth:admin'])->group(function () {
        Route::resource('category',CategoryController::class);
    });
    ```
### 分类
#### 添加分类
    - 模板
    ```php
    ```
    - 控制器
        - 创建表单验证
            ```shell
            php artisan module:make-request CategoryRequest Article
            ```
            ```php
            public function rules(): array
            {
                return [
                    'name'=>'required|unique:categories,name',
                ];
            }
            public function messages()
            {
                return [
                    'name.required'=>'栏目名称不能为空',
                    'name.unique'=>'栏目名称已经存在'
                ];
            }
            ```
        - 修改store方法
            ```php
            public function store(CategoryRequest $request,Category $category): RedirectResponse
            {
                dd($request->all());
                $category->fill($request->all());
                $category->save();
            }
            ```
            > 模型的fill填充后save也可以实现添加数据
#### 编辑分类
- 模板
    ```php
    @component('admin::components.modal',['id'=>'edit_cate_'.$cate->id,'title'=>'编辑分类','url'=>route('article.category.update',$cate->id),'method'=>'PUT'])
    <div class="row mb-3">
        <label for="name" class="col-sm-3 col-form-label text-sm-end">分类名称</label>
        <div class="col-sm-9">
            <input type="text" class="form-control" id="name" name="name" data-fv-field="name"
                autocomplete="off" value="{{$cate->name}}">
            <div class="invalid-feedback d-none" data-fv-validator="notEmpty" data-fv-for="name"
                data-fv-result="NOT_VALIDATED" id="error-name"></div>
        </div>
    </div>
    <div class="row mb-3">
        <label for="name" class="col-sm-3 col-form-label text-sm-end">父级分类</label>
        <div class="col-sm-9">
            <select aria-label="pid" class="form-control select2-hidden-accessible" id="pid" name="pid"
                tabindex="-1" aria-hidden="true">
                <option value="0" selected>顶级</option>
                @foreach($tree as $selectCateId => $selectCate)
                    @if($cate->pid == $selectCateId)
                    <option value="{{$selectCateId}}" selected>{{$selectCate['name']}}</option>
                    @elseif($cate->id == $selectCateId)
                    <option value="{{$selectCateId}}" disabled>{{$selectCate['name']}}</option>
                    @else
                    <option value="{{$selectCateId}}">{{$selectCate['name']}}</option>
                    @endif
                @endforeach
            </select>
        </div>
    </div>
    @endcomponent
    ```
- 方法
    ```php
    public function update(CategoryRequest $request,Category $category): RedirectResponse
    {
        if($category->update($request->all())){
            return redirect(route('article.category.index'))->with('success','修改分类成功');
        }else{
            return redirect(route('article.category.index'))->with('danger','修改分类失败');
        }
    }
    ```
- 修改验证,修复修改时提示已存在
    ```php
    public function rules(): array
    {
        $id = $this->route('category')?$this->route('category')->id:0;
        return [
            'name'=>'required|unique:categories,name,'.$id,
        ];
    }
    ```
#### 分类删除
- 模板
    ```php
    @component('admin::components.modal',['id'=>'del_cate_'.$cate->id,'title'=>'删除分类','url'=>route('article.category.destroy',$cate->id),'method'=>'DELETE'])
    <p>确定要删除角色{{$cate->name}}吗?</p>
    @endcomponent
    ```
- 控制器
    ```php  
    public function destroy(Category $category)
    {
        if($category->hasChild()){
            return redirect(route('article.category.index'))->with('warning','有子分类未删除');
        }
        if($category->delete()){
            return redirect(route('article.category.index'))->with('success','删除分类成功');
        }else{
            return redirect(route('article.category.index'))->with('danger','删除分类失败');
        }
    }
    ```
- 查询是否有子分类
    ```php
    public function hasChild(){
        $categories = $this->all();
        //dd($this->id);
        foreach($categories as $category){
            if($category->pid == $this->id) return true;
        }
        return false;
    }
    ```
### 文章
#### 新建控制器、模型、数据迁移
- 新建控制器
    ```shell
    php artisan module:make-controller PostController Article
    ```
- 新建模型
    ```shell
    php artisan module:make-model Post Article -fm
    ```
    > -fm参数可以同时创建工厂模式及数据迁移文件
- 修改数据迁移
    ```php
    public function up(): void
    {
        Schema::create('posts', function (Blueprint $table) {
            $table->id();
            $table->string('title')->comment('标题|input');
            $table->string('author')->nullable()->comment('作者');
            $table->text('content')->comment('内容');
            $table->string('thumb')->nullable()->comment('缩略图');
            $table->integer('click')->default(0)->comment('点击数');
            $table->timestamps();
        });
    }
    ```
    ```shell
    php artisan migrate
    ```
    > 如果想执行执行refresh,可以执行：module:migrate-refresh Article.从而不影响别的数据
- 路由
    ```php
    Route::prefix('article')->name('article.')->middleware(['web','auth:admin'])->group(function () {
        Route::resource('category',CategoryController::class);
        Route::resource('post,PostController::class);
    });
    ```
### 上传
#### 基础组件
- 控制器
    ```shell
    php artisan make:controller UploadController
    ```
- 路由
    ```php
    Route::get('/upload', [App\Http\Controllers\UploadController::class, 'make'])->name('upload');
    ```
#### 上传
- 测试视图
    ```php
    <form action="{{route('upload')}}" method="post" enctype="multipart/form-data">
        @csrf
        <div class="mb-3">
            <label for="formFile" class="form-label">请选择上传文件</label>
            <input class="form-control" type="file" id="formFile" name="file">
        </div>
        <input type="submit" value="提交" class="btn btn-success">
    </form>
    ```
    > 记得添加enctype属性
- 控制器处理
    - 图片上传
        ```php
        public function image(Request $request){
            $file = $request->file('file');
            $res = $this->move($file);
            if($res){
                return [
                    'code'=>200,
                    'msg'=>'上传成功',
                    'data'=>$res
                ];
            }else{
                return [
                    'code'=>500,
                    'msg'=>'上传失败',
                ];
            }
        }
        protected function move($file){
            $filename = $file->getBasename().Str::random(6).'.'.$file->getClientOriginalExtension();
            $dir = 'uploads/'.date('Ymd');
            if($res =$file->move($dir,$filename)){
                return url($res->getPathname());
            }else{
                return false;
            }
        }
        ```
    - 编辑器上传
        ```php
        public function editormd(Request $request){
            $file = $request->file('editormd-image-file');
            $res = $this->move($file);
            if($res){
                return [
                    'success'=>1,
                    'message'=>'上传成功',
                    'url'=>$res
                ];
            }else{
                return [
                    'success'=>0,
                    'message'=>'上传失败',
                ];
            }
        }
        ```
        ```js
        // 为editormd添加csrf
        // lib/editor.md/plugins/image-dialog/image-dialog.js
        var csrfToken = $('input[name="_token"]').val();
        var csrfField = csrfToken?"<input type='hidden' name='_token' value='"+csrfToken+"' />":'无token';
        var dialogContent = ( (settings.imageUpload) ? "<form action=\"" + action +"\" target=\"" + iframeName + "\" method=\"post\" enctype=\"multipart/form-data\" class=\"" + classPrefix + "form\">" : "<div class=\"" + classPrefix + "form\">" ) +
                                ( (settings.imageUpload) ? "<iframe name=\"" + iframeName + "\" id=\"" + iframeName + "\" guid=\"" + guid + "\"></iframe>" : "" ) +
                                "<label>" + imageLang.url + "</label>" +
                                "<input type=\"text\" data-url />" + csrfField + (function(){
        ```

### 外键约束
```php

